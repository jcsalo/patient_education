<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Early Stage Esophageal Adenocarcinoma – Patient Education</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1a50d64395dd4758108c602bb54a5bf8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Patient Education</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./scripts.html"> 
<span class="menu-text">Scripts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./patient_education_plan.html"> 
<span class="menu-text">Plan</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.youtube.com/channel/UC5Deez8jUMnLhcf72-cHA7Q"> 
<span class="menu-text">YouTube</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    <div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="ge_early_stage.docx"><i class="bi bi-file-word"></i>MS Word</a></li><li><a href="ge_early_stage.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Early Stage Esophageal Adenocarcinoma</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="intro-l-1" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="intro-l-1"><span class="header-section-number">1</span> Intro L <em>1</em></h2>
<p>I’m Dr Jonathan Salo, a GI Cancer Surgeon in Charlotte, North Carolina. These videos are designed to educate you about cancer and its treatment and help you and you cancer care team make the right decisions for you.</p>
<p>Of course, there is no substitute for the expert opinions of your cancer care team.</p>
<p>The topic of this video is early-stage adenocarcinoma of the esophagus and stomach</p>
</section>
<section id="esophagus-or-gastroesophageal-junction-2." class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="esophagus-or-gastroesophageal-junction-2."><span class="header-section-number">2</span> Esophagus or Gastroesophageal junction <em>2</em>.</h2>
<p>We will consider cancers of the esophagus and gastro-esophageal junction together, as the treatment is similar (3)</p>
</section>
<section id="treatment-is-guided-by-the-stage-of-cancer" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="treatment-is-guided-by-the-stage-of-cancer"><span class="header-section-number">3</span> Treatment is guided by the Stage of cancer</h2>
<p>The treatment recommended will depend upon the stage of the cancer.</p>
<p>If you haven’t already, this may be a good time to view the video on Diagnosis and Staging. (4)</p>
</section>
<section id="wall" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="wall"><span class="header-section-number">4</span> Wall</h2>
<p>The wall of the esophagus consists has multiple layers, and is surrounded by fat and lymph node tissue</p>
</section>
<section id="mucosa" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="mucosa"><span class="header-section-number">5</span> Mucosa</h2>
<p>On the inside is the mucosa. (5)</p>
</section>
<section id="submucosa" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="submucosa"><span class="header-section-number">6</span> Submucosa</h2>
<p>Underneath the mucosa is the submucosa. (6)</p>
</section>
<section id="muscularis" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="muscularis"><span class="header-section-number">7</span> Muscularis</h2>
<p>Outside of the mucosa are two layers of muscle, called the Muscularis. (7)</p>
</section>
<section id="t1a" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="t1a"><span class="header-section-number">8</span> T1a</h2>
<p>Esophageal cancer starts within the mucosa, and with time can invade deeper into the wall. (8)</p>
</section>
<section id="t1b" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="t1b"><span class="header-section-number">9</span> T1b</h2>
<p>With time, the cancer can grow deeper and invade the submucosa (9)</p>
</section>
<section id="t2" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="t2"><span class="header-section-number">10</span> T2</h2>
<p>The cancer can then invade into the muscularis (10)</p>
</section>
<section id="t3" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="t3"><span class="header-section-number">11</span> T3</h2>
<p>If not treated, the cancer will then grow all the way through the muscularis (11)</p>
</section>
<section id="t1a-labeled" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="t1a-labeled"><span class="header-section-number">12</span> T1a (labeled)</h2>
<p>A cancer confined to the mucosa is classified as T1a (12)</p>
</section>
<section id="t1b-1" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="t1b-1"><span class="header-section-number">13</span> T1b</h2>
<p>A cancer which invades into the submucosa is classified as T1b (13)</p>
</section>
<section id="t2-1" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="t2-1"><span class="header-section-number">14</span> T2</h2>
<p>A cancer which invades the muscularis is classified as T2 (14)</p>
</section>
<section id="t3-1" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="t3-1"><span class="header-section-number">15</span> T3</h2>
<p>A cancer which grows through the muscularis is classified as T3 (15)</p>
</section>
<section id="t3-nodes" class="level2" data-number="16">
<h2 data-number="16" class="anchored" data-anchor-id="t3-nodes"><span class="header-section-number">16</span> T3 nodes</h2>
<p>T3 tumors are at risk for spread to lymph nodes, so effective treatment will require additional treatments such as chemotherapy or radiation therapy (16)</p>
</section>
<section id="emr" class="level2" data-number="17">
<h2 data-number="17" class="anchored" data-anchor-id="emr"><span class="header-section-number">17</span> EMR</h2>
<p>Endoscopic Mucosal Resection is a procedure in which a superficial cancers can be removed endoscopically, without requiring surgery.</p>
<p>This is typically performed for T1a cancers, that just involve the mucosa. (17)</p>
</section>
<section id="lift-with-saline" class="level2" data-number="18">
<h2 data-number="18" class="anchored" data-anchor-id="lift-with-saline"><span class="header-section-number">18</span> Lift with Saline</h2>
<p>The procedure is performed by first injecting fluid underneath the mucosa to lift it off of the underlying layers.</p>
</section>
<section id="snare" class="level2" data-number="19">
<h2 data-number="19" class="anchored" data-anchor-id="snare"><span class="header-section-number">19</span> Snare</h2>
<p>A portion of the mucosa can then be removed, along with the cancer. (18)</p>
</section>
<section id="completed-emr" class="level2" data-number="20">
<h2 data-number="20" class="anchored" data-anchor-id="completed-emr"><span class="header-section-number">20</span> Completed EMR</h2>
<p>This is how the procedure looks at the end. A disk of tissue is sent to the pathologist for examination. (19)</p>
</section>
<section id="favorable" class="level2" data-number="21">
<h2 data-number="21" class="anchored" data-anchor-id="favorable"><span class="header-section-number">21</span> Favorable</h2>
<p>This is an example of the pathology specimen in ideal or “favorable” cases.</p>
<p>The tumor is confined to the middle of the specimen, and it is clear that all of the cancer has been removed.</p>
<p>This is termed a “favorable” outcome from the procedure (20)</p>
</section>
<section id="favorable-2" class="level2" data-number="22">
<h2 data-number="22" class="anchored" data-anchor-id="favorable-2"><span class="header-section-number">22</span> Favorable 2</h2>
<p>Patients with favorable features after endoscopic mucosal resection</p>
<p>frequently don’t need surgery</p>
<p>but surveillance is important to be certain there isn’t recurrence of cancer.</p>
</section>
<section id="unavorable" class="level2" data-number="23">
<h2 data-number="23" class="anchored" data-anchor-id="unavorable"><span class="header-section-number">23</span> Unavorable</h2>
<p>This is an example of the pathology specimen in an “unfavorable” situation.</p>
<p>The tumor extends to the edge of the specimen, suggesting that the tumor may have been cut across during the procedure, and there might be additional cancer left benind.</p>
</section>
<section id="unfavorable-2" class="level2" data-number="24">
<h2 data-number="24" class="anchored" data-anchor-id="unfavorable-2"><span class="header-section-number">24</span> Unfavorable 2</h2>
<p>For patients with unfavorable features after endoscopic mucosal resection, some may need surgery</p>
<p>For these patients, if surgery is not done immediately, surveillance is very important to detect a recurrence early.</p>
</section>
<section id="recurrence-2" class="level2" data-number="25">
<h2 data-number="25" class="anchored" data-anchor-id="recurrence-2"><span class="header-section-number">25</span> Recurrence <strong>2</strong></h2>
<p>It is possible for cancer to recur after endoscopic removal, particularly in cases with an unfavorable outcocome. (24)</p>
</section>
<section id="surveillance-4" class="level2" data-number="26">
<h2 data-number="26" class="anchored" data-anchor-id="surveillance-4"><span class="header-section-number">26</span> Surveillance <strong>4</strong></h2>
<p>After any sort of endoscopic removal of cancer, it is extremely important to monitor the area with regular endoscopy to ensure that all of the cancer has been remove and that there is no evidence of regrowth.</p>
<p>Surveillance endoscoy is done between 3 months and one year after the procedure, depending upon the level of concern for residual cancer (23)</p>
</section>
<section id="deep-margin-positive" class="level2" data-number="27">
<h2 data-number="27" class="anchored" data-anchor-id="deep-margin-positive"><span class="header-section-number">27</span> Deep Margin Positive</h2>
<p>A special type of an “unfavorable” situation is when there is cancer found on the deep side of the specimen.</p>
<p>In this situation, there is concern that the procedure remove the top portion of the cancer, but that there is a deeper portion of the cancer left behind. (22)</p>
</section>
<section id="positive-deep-margin" class="level2" data-number="28">
<h2 data-number="28" class="anchored" data-anchor-id="positive-deep-margin"><span class="header-section-number">28</span> Positive Deep Margin</h2>
<p>Patients with a positive deep margin are at risk for recurrence on the surface, or mucosa.</p>
</section>
<section id="section" class="level2" data-number="29">
<h2 data-number="29" class="anchored" data-anchor-id="section"><span class="header-section-number">29</span> </h2>
<p>But are also at risk of spread to lymph nodes.</p>
<p>The challenge here is that early detection of spread to the lymphd nodes is difficult</p>
</section>
<section id="section-1" class="level2" data-number="30">
<h2 data-number="30" class="anchored" data-anchor-id="section-1"><span class="header-section-number">30</span> </h2>
<p>In most cases, surgery or additional therapy is recommended to patients with a positive deep margin.</p>
</section>
<section id="lift" class="level2" data-number="31">
<h2 data-number="31" class="anchored" data-anchor-id="lift"><span class="header-section-number">31</span> Lift</h2>
<p>Going back to the Endoscoic Mucosal Resection procedure: An important first step is injection of fluid below the mucosa to life the cancer off of the underlying layers. (25)</p>
</section>
<section id="unable-to-lift" class="level2" data-number="32">
<h2 data-number="32" class="anchored" data-anchor-id="unable-to-lift"><span class="header-section-number">32</span> Unable to Lift</h2>
<p>Cancers that invade deeper into the layers of the esophagus are not candidates for endoscopic mucosal resection because it is not possible to get underneath the cancer and lift the mucosa off of the underlying layers.</p>
</section>
<section id="summary---endoscopic-therapy.-4" class="level2" data-number="33">
<h2 data-number="33" class="anchored" data-anchor-id="summary---endoscopic-therapy.-4"><span class="header-section-number">33</span> Summary - Endoscopic Therapy. <strong>4</strong></h2>
<p>In summary, endoscopic therapy can be used to remove cancers limited to the mucosa lauyer. These are considered T1a tumors (27)</p>
</section>
<section id="summary---endoscopic-therapy" class="level2" data-number="34">
<h2 data-number="34" class="anchored" data-anchor-id="summary---endoscopic-therapy"><span class="header-section-number">34</span> Summary - Endoscopic Therapy</h2>
<p>After endoscopic therapy, surveillance with endoscopy is important to make certain the cancer has been completely remove and there has been no cancer regrowth. (28)</p>
</section>
<section id="wrap-up-1" class="level2" data-number="35">
<h2 data-number="35" class="anchored" data-anchor-id="wrap-up-1"><span class="header-section-number">35</span> Wrap up <em>1</em></h2>
<p>We hope you have found this video helpful. Here are links to some other videos.</p>
<p>Feel free to leave a comment or a question, or if you have suggestions for future videos.</p>
<p>If you or a family member have had an encounter with esophageal cancer, I would love to hear about your experience, so please take a minute to leave a comment below.</p>
<p>We’re constantly creating new videos, so please subscribe to be notified of new videos when we post them. (29)</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jcsalo\.github\.io\/patient_education\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>